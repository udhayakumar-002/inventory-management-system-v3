{% extends 'base.html' %}

{% block title %}Create Purchase Order{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-shopping-cart"></i> Create Purchase Order</h2>
            <p class="text-muted">Generate a new purchase order for your suppliers</p>
        </div>
        <a href="{{ url_for('purchase_orders') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back
        </a>
    </div>

    <form method="POST" action="{{ url_for('create_purchase') }}" id="purchaseOrderForm">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0">Purchase Order Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Select Supplier <span class="text-danger">*</span></label>
                        <select class="form-control" name="supplier_id" required>
                            <option value="">-- Choose Supplier --</option>
                            {% for supplier in suppliers %}
                            <option value="{{ supplier.id }}">{{ supplier.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Expected Delivery Date</label>
                        <input type="date" class="form-control" name="expected_delivery" 
                               value="{{ now().strftime('%Y-%m-%d') if now else '' }}">
                        <small class="text-muted">When do you expect this order to be delivered?</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Order Items</h5>
                <button type="button" class="btn btn-primary btn-sm" onclick="addOrderItem()">
                    <i class="fas fa-plus"></i> Add Product
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered" id="orderItemsTable">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 40%;">Product</th>
                                <th style="width: 15%;">Quantity</th>
                                <th style="width: 20%;">Unit Price (₹)</th>
                                <th style="width: 20%;">Subtotal</th>
                                <th style="width: 5%;"></th>
                            </tr>
                        </thead>
                        <tbody id="orderItemsBody">
                            <tr class="order-item-row">
                                <td>
                                    <select class="form-control product-select" name="product_id[]" required>
                                        <option value="">-- Select Product --</option>
                                        {% for product in products %}
                                        <option value="{{ product.id }}">{{ product.name }}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td>
                                    <input type="number" class="form-control qty-input" name="quantity[]" 
                                           placeholder="Qty" min="1" required onchange="calcSubtotal(this)">
                                </td>
                                <td>
                                    <input type="number" step="0.01" class="form-control price-input" 
                                           name="unit_price[]" placeholder="0.00" min="0" required onchange="calcSubtotal(this)">
                                </td>
                                <td>
                                    <input type="text" class="form-control subtotal-display" 
                                           placeholder="₹0.00" readonly style="background: #f8f9fa;">
                                </td>
                                <td class="text-center">
                                    <button type="button" class="btn btn-danger btn-sm" onclick="removeOrderItem(this)">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0">Additional Information</h5>
            </div>
            <div class="card-body">
                <label class="form-label">Notes & Special Instructions</label>
                <textarea class="form-control" name="notes" rows="4" 
                          placeholder="Enter any special instructions, delivery requirements, or notes for the supplier..."></textarea>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <button type="submit" class="btn btn-success btn-lg me-2">
                            <i class="fas fa-check-circle"></i> Create Purchase Order
                        </button>
                        <a href="{{ url_for('purchase_orders') }}" class="btn btn-secondary btn-lg">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                    </div>
                    <div class="col-md-6 text-end">
                        <div class="card bg-primary text-white d-inline-block" style="min-width: 250px;">
                            <div class="card-body py-3">
                                <h6 class="mb-1">Order Summary</h6>
                                <h6 class="mb-0">Total Amount: <strong id="grandTotal">₹0.00</strong></h6>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
// Calculate subtotal for individual row
function calcSubtotal(element) {
    const row = element.closest('.order-item-row');
    const qty = parseFloat(row.querySelector('.qty-input').value) || 0;
    const price = parseFloat(row.querySelector('.price-input').value) || 0;
    const subtotal = qty * price;
    
    row.querySelector('.subtotal-display').value = '₹' + subtotal.toFixed(2);
    updateGrandTotal();
}

// Calculate grand total
function updateGrandTotal() {
    let total = 0;
    document.querySelectorAll('.order-item-row').forEach(row => {
        const qty = parseFloat(row.querySelector('.qty-input').value) || 0;
        const price = parseFloat(row.querySelector('.price-input').value) || 0;
        total += qty * price;
    });
    document.getElementById('grandTotal').textContent = '₹' + total.toFixed(2);
}

// Add new order item row - MATCHES BUTTON ONCLICK
function addOrderItem() {
    const tbody = document.getElementById('orderItemsBody');
    const firstRow = tbody.querySelector('.order-item-row');
    
    if (!firstRow) {
        console.error('No template row found');
        return;
    }
    
    const newRow = firstRow.cloneNode(true);
    
    // Clear values
    newRow.querySelectorAll('input').forEach(input => {
        input.value = '';
    });
    newRow.querySelector('select').selectedIndex = 0;
    
    tbody.appendChild(newRow);
    
    // Focus on product dropdown
    newRow.querySelector('.product-select').focus();
    
    console.log('New row added successfully');
}

// Remove order item row
function removeOrderItem(button) {
    const tbody = document.getElementById('orderItemsBody');
    const rows = tbody.querySelectorAll('.order-item-row');
    
    if (rows.length > 1) {
        button.closest('.order-item-row').remove();
        updateGrandTotal();
    } else {
        alert('At least one item is required!');
    }
}

// Form validation
document.getElementById('purchaseOrderForm').addEventListener('submit', function(e) {
    const supplier = document.querySelector('select[name="supplier_id"]').value;
    
    if (!supplier) {
        alert('Please select a supplier!');
        e.preventDefault();
        return false;
    }
    
    let hasValidItem = false;
    document.querySelectorAll('.order-item-row').forEach(row => {
        const product = row.querySelector('.product-select').value;
        const qty = row.querySelector('.qty-input').value;
        const price = row.querySelector('.price-input').value;
        
        if (product && qty && price) {
            hasValidItem = true;
        }
    });
    
    if (!hasValidItem) {
        alert('Please add at least one product with quantity and price!');
        e.preventDefault();
        return false;
    }
});

// Initialize on load
document.addEventListener('DOMContentLoaded', function() {
    updateGrandTotal();
    console.log('Purchase Order form initialized');
});
</script>
{% endblock %}
